---
layout: bare
---
<head>
    <title>Timelog</title>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"a></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
    <script src="backbone.localStorage-min.js"></script>
    <style>
        #what {
            width: 100%;
            margin-bottom: 1em;
        }
        #start, #stop {
            display: inline-block;
            width: 8em;
            padding: 1em 0;
            margin-right: 2em;
            background-color: #ccf;
            text-align: center;
            vertical-align: center;
        }
        .stop {
            color: #800;
        }
        .duration {
            color: #aaa
        }
        .selected .duration {
            color: #000;
        }
    </style>
</head>
<body>
    <div id="ts">
    <form autocomplete="off">
        <input name="what" id="what" type="text">
        <a href="javascript:void(0)" id="start">start</a>
        <a href="javascript:void(0)" id="stop">stop</a>

    </form>
    <div id="dates">
        <!-- <a class="js-date-prev" href="">&lt;</a><span> Today </span><a class="js-date-next" href="">&gt;</a> -->
    </div>
    <ul id="history">
    </ul>
        <a href="#" id="clear">Clear record</a>
    </div>
    <script type="text/template" id="note-tmpl">
<li><%= time %> - <%= note %> <span class="duration"><%= duration %></span></li>
    </script>
<script>
$(function () {
    var sameday = function(as) {
        return function(value) {
            var ts = value.get('timestamp')
            return as.getDate() === ts.getDate() && as.getMonth() === ts.getMonth() && as.getYear() === ts.getYear()
    }}
    var Note = Backbone.Model.extend({
        localStorage: new Backbone.LocalStorage("bb-history"),
        defaults: {
            timestamp: null,
            startstop: 'start',
            note: ''
        },
        initialize: function() {
            if (this.get('timestamp') === null) {
                var now = new Date(Date.now())
                this.set('timestamp', now)
            }
        },
        parse: function(response, options) {
            response.timestamp = new Date(response.timestamp)
            return response
        },
        template_data: function() {
            var data = this.toJSON()
            var d, t
            var dt = data.timestamp.toLocaleString().split(', ')
            data.date = dt[0]
            data.time = dt[1].slice(0, -6) + dt[1].slice(-3)
            duration = this._hour_format(this.duration())
            data.duration = ""
            if (duration) {
                if (duration[1] < 10) {
                    duration[1] = '0' + duration[1]
                }
                data.duration = duration[0] + ':' + duration[1]
            }
            return data
        },
        next: function() {
            return this.collection.at(this.collection.indexOf(this)+1)
        },
        duration: function () {
            var next = this.next()
            if (!next) {
                return
            }
            var msec = this.next().get('timestamp') - this.get('timestamp')
            var minutes = Math.floor(msec / 1000 / 60);
            return minutes
        },
        _hour_format: function (minutes) {
            if (minutes === undefined) {
                return
            }
            var hh = Math.floor(minutes / 60);
            mm = minutes % 60;
            return [hh, mm]
        }
    })

    var NoteCollection = Backbone.Collection.extend({
        model: Note,
        comparator: 'timestamp',
        localStorage: new Backbone.LocalStorage("bb-history"),
        initialize: function() {
            this.listenTo(this, 'sort', this.processAdd)
        },
        processAdd: function(collection) {
            // reset collection in case resorting needs to happen
            this.trigger('reset', collection)
        }
    })

    var NoteView = Backbone.View.extend({
        tagName: 'li',
        template: _.template($('#note-tmpl').html()),
        render: function() {
            var template_data = this.model.template_data()
            this.$el.html(this.template(template_data))
            this.$el.attr('title', template_data.date)
            this.$el.addClass(template_data.startstop)
            return this
        },
        events: {
            'click': 'toggle'
        },
        toggle: function () {
            this.model.selected = this.model.selected ? false:true
            this.$el.toggleClass('selected')
        }
    })

    var AppView = Backbone.View.extend({
        el: '#ts',

        events: {
            'click #start': 'createStart',
            'click #stop': 'createStop',
            'click #clear': 'clear',
            'submit': 'createStart'
        },
        createStart: function(ev) {
            ev.preventDefault()
            this.createNote('start')
            $('#what').focus()
        },
        createStop: function(ev) {
            ev.preventDefault()
            this.createNote('stop')
            $('#what').focus()
        },
        createNote: function(action) {
            var what = $('#what')
            var what_val = what.val()
            var now = new Date()
            // Only store date to the minute
            now.setSeconds(0)
            now.setMilliseconds(0)
            // 1-2 digits followed by optional :1-2 digits
            // followed by optional space then optional am/pm
            // ending with optional space. Case insensitive.
            // 8, 8am, 8 pm, 7:23, 7:23am
            var time_regex = /^(\d{1,2})(?::(\d{2}))? ?(am|pm)? ?/i
            var results = time_regex.exec(what_val)
            if (results) {
                manual_hours = parseInt(results[1])
                manual_minutes = parseInt(results[2]) || 0
                // If hours are greater than 24, not a valid time and ignore
                if (manual_hours < 24) {
                    if (!results[3]) {
                        var hours = now.getHours()
                        if (hours >= 12 && manual_hours < 6) {
                            manual_hours += 12
                        }
                    } else if (results[3].toUpperCase() === 'PM' && manual_hours != 12) {
                            manual_hours += 12
                    }
                    what_val = what_val.slice(results[0].length)
                    now.setHours(manual_hours)
                    now.setMinutes(manual_minutes)
                }
            }
            this.collection.create({startstop: action, note: what_val, timestamp: now})
            what.val('')
        },
        clear: function() {
            while ( (model = this.collection.shift()) ) { model.destroy() }
            this.collection.trigger('reset')
        },
        initialize: function () {
            this.$list = this.$('#history')
            this.listenTo(this.collection, 'add', this.addNote)
            this.listenTo(this.collection, 'reset', this.resetNotes)
            this.collection_filter = function (n) { return true }
            this.collection.fetch({reset: true})
        },
        addNote: function(note) {
            var view = new NoteView({model: note})
            this.$list.append(view.render().el)
        },
        resetNotes: function() {
            this.$list.html('')
            _.each(this.collection.filter(this.collection_filter), _.bind(function (note) { this.addNote(note) }, this))
            // this.collection.filter(this.addNote, this)
        },
        history: function (date) {
            this.collection_filter = _.bind(function (n) { return this.date_format(n.get('timestamp')) === date}, this)
            this.resetNotes()
        },
        today: function () {
            this.collection_filter = _.bind(function (n) { return this.date_format(n.get('timestamp')) === this.date_format(new Date())}, this)
            this.resetNotes()
        },
        worked: function () {
            var total = 0
            _.each(this.collection.filter(this.collection_filter), function (n) {
                if (n.get('startstop') == 'start') {
                    total += n.duration()
                }
            })
            return total
            // Sums: worked today, worked yesterday, worked on a date
            // work that's selected
        },
        date_format: function (date) {
            // yyyy-mm-dd
            return date.toISOString().slice(0,10)
        },
        render: function () {
        }
    })

    var appRouter = Backbone.Router.extend({
        routes: {
            "history/:date": "history",
            "today": "today"
        },
        history: function (date) {
            app.history(date)
        },
        today: function () {
            app.today()
        }

    })

    $('#what').focus()
    var app = new AppView({collection: new NoteCollection(), el: $('#ts')})
    window.app = app
    var router = new appRouter()
    Backbone.history.start()

    })
</script>
{% include tracking.html %}
</body>
